<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi-Threading · KM3io.jl</title><meta name="title" content="Multi-Threading · KM3io.jl"/><meta property="og:title" content="Multi-Threading · KM3io.jl"/><meta property="twitter:title" content="Multi-Threading · KM3io.jl"/><meta name="description" content="Documentation for KM3io.jl."/><meta property="og:description" content="Documentation for KM3io.jl."/><meta property="twitter:description" content="Documentation for KM3io.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="KM3io.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../rootfiles/">ROOT Files</a></li><li class="is-active"><a class="tocitem" href>Multi-Threading</a></li><li><a class="tocitem" href="../detector/">Detector and its Components</a></li><li><a class="tocitem" href="../calibration/">Calibration</a></li><li><a class="tocitem" href="../coordinates/">Coordinates</a></li><li><a class="tocitem" href="../auxfiles/">Auxiliary Files</a></li><li><a class="tocitem" href="../tools/">Tools</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/online_data/">Online data</a></li><li><a class="tocitem" href="../../examples/offline_data/">Offline data</a></li><li><a class="tocitem" href="../../examples/cherenkov_times/">Cherenkov times</a></li><li><a class="tocitem" href="../../examples/orientations/">Orientations</a></li><li><a class="tocitem" href="../../examples/controlhost/">Accessing Live Data</a></li><li><a class="tocitem" href="../../examples/hdf5/">HDF5</a></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Multi-Threading</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multi-Threading</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://git.km3net.de/common/KM3io.jl" title="View the repository"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">Repository</span></a><a class="docs-navbar-link" href="https://git.km3net.de/common/KM3io.jl/blob/main/docs/src/manual/multi-threading.md#L" title="Edit source"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-Threading"><a class="docs-heading-anchor" href="#Multi-Threading">Multi-Threading</a><a id="Multi-Threading-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-Threading" title="Permalink"></a></h1><p><code>KM3io.jl</code> supports multi-threading on the event (both offline and online) and summaryslice level out of the box due to Julia&#39;s built-in <code>Threads</code> package.</p><p>By default, the <code>julia</code> process uses a single thread. In order to increase the number of threads, the <code>-t N_THREADS</code> option can be used. Alternatively, the environment variable <code>JULIA_NUM_THREADS</code> can be exported and it will set the number of threads automatically for each <code>julia</code> process executed in that shell session. See the <a href="https://docs.julialang.org/en/v1/manual/multi-threading/">Julia Documentation on Multi-Threading</a> for more information.</p><p>The <code>Threads.@threads</code> macro can be used directly in front of event- or summaryslice-loops like the following example demonstrates:</p><pre><code class="language-julia hljs">using KM3io
using KM3NeTTestData


f = ROOTFile(datapath(&quot;offline&quot;, &quot;numucc.root&quot;))

Threads.@threads for event in f.offline
    println(&quot;Processing event $(event.id)&quot;)
    sleep(rand()/10)  # to mimic varying processing times
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Processing event 8
Processing event 10
Processing event 5
Processing event 2
Processing event 6
Processing event 9
Processing event 7
Processing event 1
Processing event 3
Processing event 4</code></pre><div class="admonition is-info" id="Note-6ad3d351d9f84fed"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-6ad3d351d9f84fed" title="Permalink"></a></header><div class="admonition-body"><p>The order of the items is not predefined when using threads.</p></div></div><p>Below is an example using an online file. In that example, the total number of hits with a time of threshold (ToT) of more than 50ns is counted. Note that accessing the same variable or object from multiple threads at the same time can lead to race conditions and unexpected results.</p><div class="admonition is-info" id="Note-3ba2de85705dbfdc"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-3ba2de85705dbfdc" title="Permalink"></a></header><div class="admonition-body"><p>Julia offers &quot;atomic&quot; operations which are guaranteed to be executed in a single cycle, so that no other threads are able to interfere. The input has to be an atomic type, which can be created using the <code>Threads.Atomic</code> parametric type.</p></div></div><p>Let&#39;s iterate over all online events and count the number of snapshot hits using the ToT selection. <code>n</code> is a local variable inside the loop and is therefore thread-safe. <code>n_big_hits</code> however is in the outer scope and multiple threads can potentially access (read and modify) it the same time, so we use the type <code>Threads.Atomic{Int}</code> and the thread-safe <code>atomic_add!</code> function instead of the usual <code>+</code> operator.</p><pre><code class="language-julia hljs">f = ROOTFile(datapath(&quot;online&quot;, &quot;km3net_online.root&quot;))

tot_threshold = 50  # [ns]
n_big_hits = Threads.Atomic{Int}(0)

Threads.@threads for event in f.online.events

    n = 0
    for hit in event.snapshot_hits
        if hit.tot &gt; tot_threshold
            n += 1
        end
    end

    Threads.atomic_add!(n_big_hits, n)
end

println(&quot;Number of big hits (tot &gt; $(tot_threshold)): $(n_big_hits[])&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Number of big hits (tot &gt; 50): 8</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../rootfiles/">« ROOT Files</a><a class="docs-footer-nextpage" href="../detector/">Detector and its Components »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.13.0 on <span class="colophon-date" title="Tuesday 24 June 2025 08:35">Tuesday 24 June 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

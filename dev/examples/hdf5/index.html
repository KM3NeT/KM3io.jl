<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>HDF5 ¬∑ KM3io.jl</title><meta name="title" content="HDF5 ¬∑ KM3io.jl"/><meta property="og:title" content="HDF5 ¬∑ KM3io.jl"/><meta property="twitter:title" content="HDF5 ¬∑ KM3io.jl"/><meta name="description" content="Documentation for KM3io.jl."/><meta property="og:description" content="Documentation for KM3io.jl."/><meta property="twitter:description" content="Documentation for KM3io.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="KM3io.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../manual/rootfiles/">ROOT Files</a></li><li><a class="tocitem" href="../../manual/detector/">Detector and its Components</a></li><li><a class="tocitem" href="../../manual/calibration/">Calibration</a></li><li><a class="tocitem" href="../../manual/tools/">Tools</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../offline_data/">Offline data</a></li><li><a class="tocitem" href="../cherenkov_times/">Cherenkov times</a></li><li><a class="tocitem" href="../controlhost/">Accessing Live Data</a></li><li class="is-active"><a class="tocitem" href>HDF5</a><ul class="internal"><li><a class="tocitem" href="#Creating-datasets"><span>Creating datasets</span></a></li><li><a class="tocitem" href="#Reading-datasets"><span>Reading datasets</span></a></li><li><a class="tocitem" href="#Adding-metadata"><span>Adding metadata</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>HDF5</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>HDF5</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://git.km3net.de/common/KM3io.jl" title="View the repository"><span class="docs-icon fa-brands">Ô°Å</span><span class="docs-label is-hidden-touch">Repository</span></a><a class="docs-navbar-link" href="https://git.km3net.de/common/KM3io.jl/blob/main/docs/src/examples/hdf5.md#L" title="Edit source"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="HDF5"><a class="docs-heading-anchor" href="#HDF5">HDF5</a><a id="HDF5-1"></a><a class="docs-heading-anchor-permalink" href="#HDF5" title="Permalink"></a></h1><p>Plain ASCII (CSV) files are often perfectly fine for small, tabular datasets but when dealing with larger amounts of data, HDF5 comes in handy with compression, metadata and hierachical datasets. KM3NeT uses HDF5 in many analysis chains, often to store intermediate or end results.</p><p>This example shows how to create an HDF5 file and write some vectors of structs into different datasets.</p><pre><code class="language-julia hljs">using KM3io
using Random

Random.seed!(23)  # to make things reproducible ;)

f = H5File(&quot;foo.h5&quot;, &quot;w&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">H5File(HDF5.File: (read-write) foo.h5, Dict{String, H5CompoundDataset}(), ReentrantLock(nothing, 0x00000000, 0x00, Base.GenericCondition{Base.Threads.SpinLock}(Base.IntrusiveLinkedList{Task}(nothing, nothing), Base.Threads.SpinLock(0)), (0, 139798621683480, 141733920768)))</code></pre><p>We now have an <code>H5File</code> instance which we can use to store datasets.</p><p>Let&#39;s say we have our custom data type (<code>struct</code>) like</p><pre><code class="language-julia hljs">struct Particle
    x::Float32
    y::Float32
    E::Int64
end</code></pre><p>and we generate instances of <code>Particle</code> in a loop which we want to dump directly into an HDF5 file to the dataset stored at <code>simulation/particles</code>, meaning that <code>simulation</code> is the group name and <code>particles</code> the dataset name.</p><h2 id="Creating-datasets"><a class="docs-heading-anchor" href="#Creating-datasets">Creating datasets</a><a id="Creating-datasets-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-datasets" title="Permalink"></a></h2><p>First, we create our dataset with our type <code>Particle</code>. This is a so called <code>H5CompoundDataset</code> and resembles a dataset wich has a compound type (<code>struct</code>) associated with it:</p><pre><code class="language-julia hljs">dset = create_dataset(f, &quot;simulation/particles&quot;, Particle)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">H5CompoundDataset{Main.Particle}(HDF5.Dataset: /simulation/particles (file: foo.h5 xfer_mode: 0), KM3io.H5CompoundDatasetCache{Main.Particle}(Main.Particle[], 10000), ReentrantLock(nothing, 0x00000000, 0x00, Base.GenericCondition{Base.Threads.SpinLock}(Base.IntrusiveLinkedList{Task}(nothing, nothing), Base.Threads.SpinLock(0)), (0, 139798621683480, 141733920768)))</code></pre><p>We fill some random particles using the dummy loop:</p><pre><code class="language-julia hljs">for i in 1:1000
    # creates some random particle
    particle = Particle(rand(), rand(), rand(1:1000))
    # we push to the dataset, just like if it was an Array
    push!(dset, particle)
end</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>To avoid excessive I/O, KM3io uses a cache for each <code>H5CompoundDataset</code>. If you don&#39;t close the <code>H5File</code> properly, you might lose data which is still sitting in the cache. Therefore, always use <code>close(f)</code> to make sure that all the caches are dumped to the HDF5 file. The methods <code>flush(d::H5CompoundDataset)</code> and <code>flush(f::H5File)</code> can be used to manually to prematurely flush the cache of a dataset or all caches of an HDF5 file respectively.</p></div></div><p>Let&#39;s close the file</p><pre><code class="language-julia hljs">close(f)</code></pre><h2 id="Reading-datasets"><a class="docs-heading-anchor" href="#Reading-datasets">Reading datasets</a><a id="Reading-datasets-1"></a><a class="docs-heading-anchor-permalink" href="#Reading-datasets" title="Permalink"></a></h2><p>We open the file from the previous example with <code>HDF5.jl</code>, just to demonstrate that we can read it without any <code>KM3NeT</code> related libraries:</p><pre><code class="language-julia hljs">using HDF5

f = h5open(&quot;foo.h5&quot;)
particles = f[&quot;simulation/particles&quot;]

@show particles[1:5]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">5-element Vector{NamedTuple{(:x, :y, :E), Tuple{Float32, Float32, Int64}}}:
 (x = 0.6173128, y = 0.7017544, E = 846)
 (x = 0.15231268, y = 0.5729589, E = 919)
 (x = 0.3698977, y = 0.9852652, E = 29)
 (x = 0.20275348, y = 0.61091214, E = 43)
 (x = 0.9130694, y = 0.80798453, E = 492)</code></pre><p>Notice that <code>HDF5.jl</code> automatically created <code>NamedTuple</code> instances with the same fieldnames as our own <code>struct</code> definition of <code>Particle</code>. This means that the elements behave just like the original one regarding the field access:</p><pre><code class="language-julia hljs">particles[2].E</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">919</code></pre><p>The whole vector can also be reinterpreted to the original <code>struct</code> definition with zero-cost. This can be mandatory if the data is then passed to other methods which require a specific type (in this case <code>Particle</code>). The following line will only work if <code>Particle</code> is already defined (i.e. the correspoinding module has been loaded). It is also mandatory to pass a slice (here, we pass the full slice by using <code>[:]</code>) to <code>reinterpret</code> and not the dataset itself:</p><pre><code class="language-julia hljs">reinterpreted_particles = reinterpret(Particle, particles[:])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1000-element reinterpret(Main.Particle, ::Vector{NamedTuple{(:x, :y, :E), Tuple{Float32, Float32, Int64}}}):
 Main.Particle(0.6173128f0, 0.7017544f0, 846)
 Main.Particle(0.15231268f0, 0.5729589f0, 919)
 Main.Particle(0.3698977f0, 0.9852652f0, 29)
 Main.Particle(0.20275348f0, 0.61091214f0, 43)
 Main.Particle(0.9130694f0, 0.80798453f0, 492)
 Main.Particle(0.64656323f0, 0.22889934f0, 645)
 Main.Particle(0.6973233f0, 0.50635964f0, 273)
 Main.Particle(0.40650654f0, 0.3752744f0, 761)
 Main.Particle(0.95921856f0, 0.50115997f0, 367)
 Main.Particle(0.33829075f0, 0.14806244f0, 259)
 ‚ãÆ
 Main.Particle(0.3361519f0, 0.85591096f0, 550)
 Main.Particle(0.6328468f0, 0.9447911f0, 602)
 Main.Particle(0.77841556f0, 0.89120376f0, 336)
 Main.Particle(0.6592056f0, 0.43078482f0, 478)
 Main.Particle(0.39405528f0, 0.71947837f0, 995)
 Main.Particle(0.8272534f0, 0.04592278f0, 144)
 Main.Particle(0.10343988f0, 0.1650157f0, 186)
 Main.Particle(0.81352913f0, 0.4152046f0, 815)
 Main.Particle(0.9511939f0, 0.5394598f0, 921)</code></pre><p>Each element is now a proper <code>Particle</code> instance:</p><pre><code class="language-julia hljs">reinterpreted_particles[4]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.Particle(0.20275348f0, 0.61091214f0, 43)</code></pre><p><code>KM3io</code> also writes the name of the <code>struct</code> into the attributes of the dataset:</p><pre><code class="language-julia hljs">attrs(particles)[&quot;struct_name&quot;]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;Particle&quot;</code></pre><h2 id="Adding-metadata"><a class="docs-heading-anchor" href="#Adding-metadata">Adding metadata</a><a id="Adding-metadata-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-metadata" title="Permalink"></a></h2><p>Sometimes it&#39;s useful to keep track of additional metadata, e.g. a given set of parameters for a specific dataset. The <code>addmeta()</code> function can be used to attach key-value-pairs from a struct to a variety of HDF5 structures, like files, datasets or groups. The following example demonstrates it:</p><pre><code class="language-julia hljs">using KM3io
using HDF5

struct SimulationParameters
    can_height::Int32
    can_radius::Int32
    minimum_energy::Float64
    maximum_energy::Float64
end

simparams = SimulationParameters(800, 200, 1e3, 1e7)

f = h5open(&quot;simulation.h5&quot;, &quot;w&quot;)
addmeta(f, simparams)

attributes(f)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">üóÇÔ∏è Attributes of HDF5.File: (read-write) simulation.h5
‚îú‚îÄ üè∑Ô∏è can_height
‚îú‚îÄ üè∑Ô∏è can_radius
‚îú‚îÄ üè∑Ô∏è maximum_energy
‚îî‚îÄ üè∑Ô∏è minimum_energy</code></pre><p>To access individual attributes, use <code>HDF5.read_attribute</code>:</p><pre><code class="language-julia hljs">read_attribute(f, &quot;can_radius&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">200</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>It is possible to add metadata to datasets and groups too. Make sure that the struct you pass to <code>addmeta()</code> only contains primitive types or strings in their fields. Arrays and other nested or compound fieldtypes are not supported by HDF5.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../controlhost/">¬´ Accessing Live Data</a><a class="docs-footer-nextpage" href="../../api/">API ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 20 March 2024 10:04">Wednesday 20 March 2024</span>. Using Julia version 1.9.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>

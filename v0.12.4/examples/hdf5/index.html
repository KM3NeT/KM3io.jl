<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Writing HDF5 · KM3io.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="KM3io.jl logo"/></a><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../manual/rootfiles/">ROOT Files</a></li><li><a class="tocitem" href="../../manual/detector/">Detector and its Components</a></li><li><a class="tocitem" href="../../manual/calibration/">Calibration</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../offline_data/">Offline data</a></li><li><a class="tocitem" href="../cherenkov_times/">Cherenkov times</a></li><li><a class="tocitem" href="../controlhost/">Accessing Live Data</a></li><li class="is-active"><a class="tocitem" href>Writing HDF5</a></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Writing HDF5</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Writing HDF5</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://git.km3net.de/common/KM3io.jl/blob/main/docs/src/examples/hdf5.md#L" title="Edit source"><span class="docs-icon fa"></span><span class="docs-label is-hidden-touch">Edit source</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Writing-HDF5"><a class="docs-heading-anchor" href="#Writing-HDF5">Writing HDF5</a><a id="Writing-HDF5-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-HDF5" title="Permalink"></a></h1><p>Plain ASCII (CSV) files are often perfectly fine for small, tabular datasets but when dealing with larger amounts of data, HDF5 comes in handy with compression, metadata and hierachical datasets. KM3NeT uses HDF5 in many analysis chains, often to store intermediate or end results.</p><p>This example shows how to create an HDF5 file and write some vectors of structs into different datasets.</p><pre><code class="language- hljs">using KM3io
using Random

Random.seed!(23)  # to make things reproducible ;)

f = H5File(&quot;foo.h5&quot;)</code></pre><p>We now have an <code>H5File</code> instance which we can use to store datasets.</p><p>Let&#39;s say we have our custom data type (<code>struct</code>) like</p><pre><code class="language-julia hljs">struct Particle
    x::Float32
    y::Float32
    E::Int64
end</code></pre><p>and we generate instances of <code>Particle</code> in a loop which we want to dump directly into an HDF5 file to the dataset stored at <code>simulation/particles</code>, meaning that <code>simulation</code> is the group name and <code>particles</code> the dataset name.</p><p>First, we create our dataset with our type <code>Particle</code>. This is a so called <code>H5CompoundDataset</code> and resembles a dataset wich has a compound type (<code>struct</code>) associated with it:</p><pre><code class="language- hljs">dset = create_dataset(f, &quot;simulation/particles&quot;, Particle)</code></pre><p>We fill some random particles using the dummy loop:</p><pre><code class="language- hljs">for i in 1:1000
    # creates some random particle
    particle = Particle(rand(), rand(), rand(1:1000))
    # we push to the dataset, just like if it was an Array
    push!(dset, particle)
end</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>To avoid excessive I/O, KM3io uses a cache for each <code>H5CompoundDataset</code>. If you don&#39;t close the <code>H5File</code> properly, you might lose data which is still sitting in the cache. Therefore, always use <code>close(f)</code> to make sure that all the caches are dumped to the HDF5 file. The methods <code>flush(d::H5CompoundDataset)</code> and <code>flush(f::H5File)</code> can be used to manually to prematurely flush the cache of a dataset or all caches of an HDF5 file respectively.</p></div></div><p>Let&#39;s close the file</p><pre><code class="language- hljs">close(f)</code></pre><p>and open it again with <code>HDF5.jl</code>, just to demonstrate that we can read it without any <code>KM3NeT</code> related libraries:</p><pre><code class="language- hljs">using HDF5

f = h5open(&quot;foo.h5&quot;)
particles = f[&quot;simulation/particles&quot;]

@show particles[1:5]</code></pre><p>Notice that <code>HDF5.jl</code> automatically created <code>NamedTuple</code> instances with the same fieldnames as our own <code>struct</code> definition of <code>Particle</code>. This means that the elements behave just like the original one regarding the field access:</p><pre><code class="language- hljs">particles[2].E</code></pre><p>The whole vector can also be reinterpreted to the original <code>struct</code> definition with zero-cost. This can be mandatory if the data is then passed to other methods which require a specific type (in this case <code>Particle</code>). The following line will only work if <code>Particle</code> is already defined (i.e. the correspoinding module has been loaded). It is also mandatory to pass a slice (here, we pass the full slice by using <code>[:]</code>) to <code>reinterpret</code> and not the dataset itself:</p><pre><code class="language- hljs">reinterpreted_particles = reinterpret(Particle, particles[:])</code></pre><p>Each element is now a proper <code>Particle</code> instance:</p><pre><code class="language- hljs">reinterpreted_particles[4]</code></pre><p><code>KM3io</code> also writes the name of the <code>struct</code> into the attributes of the dataset:</p><pre><code class="language- hljs">attrs(particles)[&quot;struct_name&quot;]</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../controlhost/">« Accessing Live Data</a><a class="docs-footer-nextpage" href="../../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Friday 26 May 2023 06:23">Friday 26 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
